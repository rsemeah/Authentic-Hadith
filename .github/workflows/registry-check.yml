name: NPM Registry Access Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  registry-check:
    name: Check NPM Registry Accessibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check NPM Registry Access
        id: registry_check
        run: |
          echo "üîç Checking npm registry accessibility..."
          echo "================================================"

          # Test registry access
          if curl -f -s -I --max-time 10 \
            https://registry.npmjs.org/ > /dev/null 2>&1; then
            echo "‚úÖ NPM registry (https://registry.npmjs.org) is accessible"
            REGISTRY_STATUS="success"
          else
            echo "‚ùå FAILED: Cannot access NPM registry"
            echo "   (https://registry.npmjs.org)"
            REGISTRY_STATUS="failed"
          fi

          # Test a specific package (typescript as this repo is a VS Code extension)
          echo ""
          echo "üîç Testing package download (typescript)..."
          if curl -f -s --max-time 10 \
            https://registry.npmjs.org/typescript > /dev/null 2>&1; then
            echo "‚úÖ Package metadata download works"
            PACKAGE_STATUS="success"
          else
            echo "‚ùå FAILED: Cannot download package metadata"
            PACKAGE_STATUS="failed"
          fi

          echo ""
          echo "================================================"

          # Check if any test failed
          if [ "$REGISTRY_STATUS" = "failed" ] || \
            [ "$PACKAGE_STATUS" = "failed" ]; then
            echo ""
            echo "üö® NPM REGISTRY ACCESS FAILURE DETECTED"
            echo "================================================"
            echo ""
            echo "The npm registry (https://registry.npmjs.org) is not"
            echo "accessible. This will cause all npm install/build"
            echo "commands to fail with 403 or timeout errors."
            echo ""
            echo "üìã TROUBLESHOOTING STEPS:"
            echo ""
            echo "1. CHECK NETWORK/PROXY SETTINGS:"
            echo "   - Verify your internet connection is active"
            echo "   - Check if you're behind a corporate proxy or firewall"
            echo "   - Ensure https://registry.npmjs.org is not blocked"
            echo ""
            echo "2. VERIFY NPM CONFIGURATION:"
            echo "   - Run: npm config get registry"
            echo "   - Should return: https://registry.npmjs.org/"
            echo "   - If different, reset with:"
            echo "     npm config set registry https://registry.npmjs.org/"
            echo ""
            echo "3. TEST REGISTRY ACCESS LOCALLY:"
            echo "   - Run: curl -I https://registry.npmjs.org/"
            echo "   - Should return: HTTP/2 200"
            echo "   - If 403/blocked, contact your network administrator"
            echo ""
            echo "4. FOR PROXY ENVIRONMENTS:"
            echo "   - Configure npm proxy:"
            echo "     npm config set proxy http://proxy:port"
            echo "   - Configure https proxy:"
            echo "     npm config set https-proxy http://proxy:port"
            echo ""
            echo "5. ALTERNATIVE REGISTRIES (temporary workaround):"
            echo "   - Use a mirror:"
            echo "     npm config set registry https://registry.npmmirror.com/"
            echo "   - Note: Not recommended for production deployments"
            echo ""
            echo "6. FOR CI/CD ENVIRONMENTS:"
            echo "   - Ensure GitHub Actions runners have internet access"
            echo "   - Check organization/repository network settings"
            echo "   - Verify no IP blocking or rate limiting"
            echo ""
            echo "7. DEPLOYMENT PLATFORMS:"
            echo "   - Vercel: Registry access is built-in, no action needed"
            echo "   - Railway: Ensure no custom network restrictions"
            echo "   - Docker: Use --network=host or check container networking"
            echo ""
            echo "üìö See DEPLOYMENT.md for detailed guidance on registry"
            echo "   access issues."
            echo ""
            echo "================================================"
            exit 1
          fi

          echo ""
          echo "‚úÖ All registry access checks passed!"
          echo "‚úÖ Ready to proceed with npm install and build"

      - name: Debug & Install Dependencies
        run: |
          echo "npm version: $(npm --version)"
          echo "node version: $(node --version)"
          echo "registry: $(npm config get registry)"
          echo "--- .npmrc (if present) ---"
          [ -f .npmrc ] && sed -n '1,200p' .npmrc || echo "(no .npmrc)"
          echo "--- package.json dependencies ---"
          if command -v jq >/dev/null 2>&1; then jq '.dependencies, .devDependencies' package.json || true; else cat package.json; fi
          echo "--- Attempt npm ci (verbose) ---"
          npm ci --loglevel=verbose --no-audit || {
            echo "npm ci failed ‚Äî printing npm-debug.log if present"
            [ -f npm-debug.log ] && sed -n '1,400p' npm-debug.log || true
            echo "Retrying with npm install to get more debug output..."
            npm install --loglevel=verbose --no-audit || exit 1
          }

      - name: Verify Installation
        run: |
          echo "üîç Verifying critical packages are installed..."
          echo "================================================"

          echo "node_modules listing (top):"
          ls -la node_modules | sed -n '1,200p' || true

          # Check for typescript (important for this VS Code extension)
          if [ -d "node_modules/typescript" ] || [ -d "node_modules/@types/vscode" ]; then
            echo "‚úÖ typescript/@types/vscode package installed"
          else
            echo "‚ùå Critical TypeScript/VS Code types missing"
            echo "Printing installed packages and npm ls typescript..."
            npm ls typescript || true
            [ -f npm-debug.log ] && sed -n '1,400p' npm-debug.log || true
            exit 1
          fi

          echo ""
          echo "TypeScript version:"
          npx tsc --version || echo "‚ö†Ô∏è  Could not determine TypeScript version"

          echo ""
          echo "================================================"
          echo "‚úÖ All critical packages verified!"

      - name: Build Project
        run: npm run compile

      - name: Success Summary
        if: success()
        run: |
          echo ""
          echo "================================================"
          echo "‚úÖ NPM REGISTRY CHECK: PASSED"
          echo "================================================"
          echo ""
          echo "Registry is accessible ‚úì"
          echo "Dependencies installed ‚úì"
          echo "Build completed successfully ‚úì"
          echo ""
          echo "This PR is ready to merge!"
          echo "================================================"

      - name: Failure Summary
        if: failure()
        run: |
          echo ""
          echo "================================================"
          echo "‚ùå BUILD FAILED"
          echo "================================================"
          echo ""
          echo "One or more steps failed. Common causes:"
          echo ""
          echo "1. NPM registry is blocked (see logs above)"
          echo "2. Missing or incorrect package versions"
          echo "3. Build errors in source code"
          echo "4. TypeScript compilation errors"
          echo ""
          echo "Review the logs above for specific error messages."
          echo "See DEPLOYMENT.md for troubleshooting guidance."
          echo "================================================"